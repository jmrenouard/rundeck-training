<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Fichier de Propriétés Rundeck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" integrity="sha384-+pxiN6T7yvpryuJmE1gM9PX7yQit15auDb+ZwwvJOd/4be2Cie5/IuVXgQb/S9du" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs/dist/bcrypt.min.js" defer></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        [x-cloak] { display: none !important; }
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            transition: all 150ms ease-in-out;
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.5);
        }
    </style>
</head>
<body
    x-data="propertyFileGenerator"
    x-init="init()"
    class="bg-slate-100 text-slate-800 font-sans antialiased"
    x-cloak
>
    <div class="flex min-h-screen">
        <!-- Contenu principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:mr-[40rem]">
            <div class="max-w-5xl mx-auto">
                <header class="text-center mb-8">
                    <div class="flex justify-center items-center mb-4">
                        <button @click="setLang('fr')" :class="{ 'bg-blue-600 text-white': lang === 'fr', 'bg-slate-200': lang !== 'fr' }" class="px-4 py-2 rounded-l-lg transition">FR</button>
                        <button @click="setLang('en')" :class="{ 'bg-blue-600 text-white': lang === 'en', 'bg-slate-200': lang !== 'en' }" class="px-4 py-2 rounded-r-lg transition">EN</button>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-900" x-text="t('title')"></h1>
                </header>

                <div class="flex justify-end items-center mb-6">
                    <button @click="addUser()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" x-text="t('add_user')">
                    </button>
                </div>

                <!-- Section d'importation -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 mb-8 p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-3" x-text="t('import_section_title')"></h2>
                    <textarea x-model="textToImport" class="form-input w-full h-32 font-mono text-sm" :placeholder="t('import_placeholder')"></textarea>
                    <div class="flex items-center justify-between mt-3">
                        <button @click="importFromText()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition" x-text="t('import_button')">
                        </button>
                        <div x-show="importStatus.message"
                             :class="{ 'text-green-600': !importStatus.isError, 'text-red-600': importStatus.isError }"
                             x-text="importStatus.message"
                             class="text-sm font-medium">
                        </div>
                    </div>
                </div>

                <!-- Boucle sur chaque utilisateur -->
                <template x-for="(user, userIndex) in users" :key="user.id">
                    <div class="bg-white rounded-lg shadow-md border border-slate-200 mb-8">
                        <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-800" x-text="`${t('user_title')} #${userIndex + 1}`"></h2>
                            <button @click="removeUser(userIndex)" class="text-red-500 hover:text-red-700 transition" x-show="users.length > 0" :title="t('remove_user_title')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Username -->
                            <div>
                                <label :for="`user-${userIndex}-username`" class="block text-lg font-semibold mb-2" x-text="t('username_label')"></label>
                                <input :id="`user-${userIndex}-username`" type="text" class="form-input" x-model="user.username" :placeholder="t('username_placeholder')">
                            </div>

                            <!-- Password -->
                            <div>
                                <label :for="`user-${userIndex}-password`" class="block text-lg font-semibold mb-2" x-text="t('password_label')"></label>
                                <div class="flex items-center space-x-4">
                                    <div class="relative flex-grow">
                                        <input :id="`user-${userIndex}-password`" :type="user.showPassword ? 'text' : 'password'" class="form-input" x-model="user.password" :placeholder="t('password_placeholder')" @change="handlePasswordChange(user)">
                                        <button @click="user.showPassword = !user.showPassword" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700" :title="user.showPassword ? t('hide_password') : t('show_password')">
                                            <svg x-show="!user.showPassword" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                            <svg x-show="user.showPassword" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.673.124 2.458.35M18.828 14.172a4 4 0 10-5.656-5.656l-5.657 5.657a4 4 0 005.656 5.656l5.657-5.657z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12a2 2 0 10-2.828-2.828" /></svg>
                                        </button>
                                    </div>
                                    <select x-model="user.encoding" @change="handlePasswordChange(user)" class="form-input w-1/3">
                                        <option value="plaintext">Plaintext</option>
                                        <option value="OBF">OBF</option>
                                        <option value="MD5">MD5</option>
                                        <option value="BCRYPT">BCRYPT</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Groups -->
                            <div>
                                <label :for="`user-${userIndex}-groups`" class="block text-lg font-semibold mb-2" x-text="t('groups_label')"></label>
                                <input :id="`user-${userIndex}-groups`" type="text" class="form-input" x-model="user.groups" :placeholder="t('groups_placeholder')">
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </main>

        <!-- Panneau de résultat -->
        <aside class="fixed top-0 right-0 h-screen w-[40rem] hidden lg:flex flex-col p-4">
            <div class="bg-slate-800 rounded-lg shadow-2xl overflow-hidden h-full flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center p-4 bg-slate-900">
                    <h3 class="text-lg font-semibold text-white" x-text="t('generated_file_title')"></h3>
                    <button @click="copyToClipboard()" class="flex items-center gap-2 px-4 py-2 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <span x-text="copySuccess ? t('copy_button_success') : t('copy_button')"></span>
                    </button>
                </div>
                <pre class="flex-1 overflow-y-auto p-4"><code class="text-slate-300 text-sm whitespace-pre-wrap" x-text="generatedFileContent"></code></pre>
            </div>
        </aside>
    </div>

    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('propertyFileGenerator', () => ({
            users: [
                {
                    id: Date.now(),
                    username: '',
                    password: '',
                    encoding: 'plaintext',
                    groups: '',
                    showPassword: false,
                    isHashing: false
                }
            ],
            lang: 'fr',
            copySuccess: false,
            textToImport: '',
            importStatus: { message: '', isError: false },

            translations: {
                fr: {
                    title: "Générateur de Fichier de Propriétés Rundeck",
                    add_user: "Ajouter un utilisateur",
                    generated_file_title: "Fichier de propriétés généré",
                    copy_button: "Copier",
                    copy_button_success: "Copié !",
                    user_title: "Utilisateur",
                    remove_user_title: "Supprimer cet utilisateur",
                    username_label: "Nom d'utilisateur",
                    username_placeholder: "ex: admin",
                    password_label: "Mot de passe",
                    password_placeholder: "Entrez le mot de passe",
                    show_password: "Afficher le mot de passe",
                    hide_password: "Masquer le mot de passe",
                    groups_label: "Groupes",
                    groups_placeholder: "ex: admin,user",
                    import_section_title: "Importer un fichier existant",
                    import_placeholder: "Collez votre contenu de realm.properties ici...",
                    import_button: "Importer et Remplir le Formulaire",
                    import_empty: "Le champ est vide.",
                    import_success: "Importation réussie : {count} utilisateur(s) chargé(s).",
                    import_error: "Erreur d'importation: format de ligne non valide.",
                    import_no_user: "Aucun utilisateur valide trouvé.",
                },
                en: {
                    title: "Rundeck Property File Generator",
                    add_user: "Add User",
                    generated_file_title: "Generated Property File",
                    copy_button: "Copy",
                    copy_button_success: "Copied!",
                    user_title: "User",
                    remove_user_title: "Remove this user",
                    username_label: "Username",
                    username_placeholder: "e.g.: admin",
                    password_label: "Password",
                    password_placeholder: "Enter password",
                    show_password: "Show password",
                    hide_password: "Hide password",
                    groups_label: "Groups",
                    groups_placeholder: "e.g.: admin,user",
                    import_section_title: "Import Existing File",
                    import_placeholder: "Paste your realm.properties content here...",
                    import_button: "Import and Fill Form",
                    import_empty: "The field is empty.",
                    import_success: "Import successful: {count} user(s) loaded.",
                    import_error: "Import error: invalid line format.",
                    import_no_user: "No valid users found.",
                }
            },

            init() {
                this.$watch('lang', () => {
                    document.title = this.t('title');
                });
            },

            setLang(lang) {
                this.lang = lang;
            },

            t(key, replacements = {}) {
                let translation = this.translations[this.lang][key] || key;
                Object.entries(replacements).forEach(([k, v]) => {
                    translation = translation.replace(`{${k}}`, v);
                });
                return translation;
            },

            newUser() {
                return {
                    id: Date.now(),
                    username: '',
                    password: '',
                    encoding: 'plaintext',
                    groups: '',
                    showPassword: false,
                    isHashing: false
                }
            },

            addUser() {
                this.users.push(this.newUser());
            },

            removeUser(index) {
                this.users.splice(index, 1);
            },

            importFromText() {
                if (!this.textToImport.trim()) {
                    this.showImportStatus(this.t('import_empty'), true);
                    return;
                }
                const lines = this.textToImport.trim().split('\n');
                const importedUsers = lines.map(line => {
                    if (line.startsWith('#') || line.trim() === '') return null;

                    const [username, rest] = line.split(/:\s*/);
                    if (!rest) return null;

                    const parts = rest.split(',');
                    const password = parts.shift().trim();
                    const groups = parts.join(',');

                    const user = this.newUser();
                    user.username = username.trim();
                    user.groups = groups;

                    if (password.startsWith('OBF:')) {
                        user.encoding = 'OBF';
                        user.password = this.deobfuscate(password);
                    } else if (password.startsWith('MD5:')) {
                        user.encoding = 'MD5';
                        user.password = password.substring(4); // We store the raw hash
                    } else if (password.startsWith('BCRYPT:')) {
                        user.encoding = 'BCRYPT';
                        user.password = password; // Store the full BCRYPT string
                    } else {
                        user.encoding = 'plaintext';
                        user.password = password;
                    }
                    return user;

                }).filter(Boolean);

                if (importedUsers.length > 0) {
                    this.users = importedUsers;
                    this.showImportStatus(this.t('import_success', { count: importedUsers.length }));
                } else {
                    this.showImportStatus(this.t('import_no_user'), true);
                }
            },

            showImportStatus(message, isError = false) {
                this.importStatus = { message, isError };
                setTimeout(() => { this.importStatus.message = ''; }, 5000);
            },

            copyToClipboard() {
                if (this.generatedFileContent) {
                    navigator.clipboard.writeText(this.generatedFileContent);
                    this.copySuccess = true;
                    setTimeout(() => { this.copySuccess = false; }, 2000);
                }
            },

            get generatedFileContent() {
                const lines = this.users.map(user => {
                    if (!user.username) return '';

                    let passwordPart = user.password;
                    switch (user.encoding) {
                        case 'OBF':
                            if (user.password) passwordPart = this.obfuscate(user.password);
                            break;
                        case 'MD5':
                            if (user.password) passwordPart = 'MD5:' + CryptoJS.MD5(user.password).toString();
                            break;
                        case 'BCRYPT':
                             if (user.isHashing) {
                                passwordPart = '...'; // Hachage en cours
                            }
                            break;
                    }

                    let line = `${user.username}: ${passwordPart}`;
                    if (user.groups) {
                        line += `,${user.groups}`;
                    }
                    return line;
                });
                return lines.filter(Boolean).join('\n');
            },

            handlePasswordChange(user) {
                if (user.encoding === 'BCRYPT' && user.password && !user.password.startsWith('BCRYPT:')) {
                    this.hashBcryptPassword(user);
                }
            },

            hashBcryptPassword(user) {
                user.isHashing = true;
                if (typeof bcrypt === 'undefined') {
                    console.error("bcrypt.js is not loaded.");
                    user.password = "BCRYPT library not loaded.";
                    user.isHashing = false;
                    return;
                }
                // Utiliser un coût de 10 est un bon compromis sécurité/performance.
                const saltRounds = 10;
                bcrypt.hash(user.password, saltRounds, (err, hash) => {
                    if (err) {
                        console.error("Bcrypt hashing error:", err);
                        user.password = "Error during hashing.";
                    } else if (hash) {
                        user.password = 'BCRYPT:' + hash;
                    }
                    user.isHashing = false;
                });
            },

            deobfuscate(password) {
                let s = password;
                if (s.startsWith('OBF:')) {
                    s = s.substring(4);
                }
                let plain = "";
                for (let i = 0; i < s.length; i += 4) {
                    const l = parseInt(s.substring(i, i + 4), 36);
                    const b2 = (l / 256);
                    const b1 = l % 256;
                    plain += String.fromCharCode(b1, b2);
                }
                return plain;
            },

            obfuscate(password) {
                let s = "";
                for (let i = 0; i < password.length; i += 2) {
                    const b1 = password.charCodeAt(i);
                    const b2 = i + 1 < password.length ? password.charCodeAt(i + 1) : 0;
                    const l = b1 + (b2 * 256);
                    let str = l.toString(36);
                    while(str.length < 4) str = "0" + str;
                    s += str;
                }
                return "OBF:" + s;
            }
        }));
    });
    </script>
</body>
</html>
