<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundeck Job YAML Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body {
            background-color: #f3f4f6;
        }
        .form-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            border-radius: 6px;
            border-color: #d1d5db;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.3);
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .info-icon {
            cursor: help;
        }
        .tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            z-index: 10;
            width: 300px;
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8" x-cloak x-data="jobBuilder()">
    <div class="max-w-screen-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Rundeck Job YAML Generator</h1>
        <p class="text-gray-600 mb-8">Create multi-step job definitions using the form below. The YAML output will be generated on the right.</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Side: Form -->
            <div class="space-y-6">
                <!-- Job Details -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Job Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="font-medium text-gray-700">Name</label>
                            <input type="text" x-model="job.name" placeholder="my-awesome-job" class="form-input mt-1">
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Group</label>
                            <input type="text" x-model="job.group" placeholder="jobs/production" class="form-input mt-1">
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Description</label>
                            <textarea x-model="job.description" rows="4" placeholder="First line is the short description.&#10;Subsequent lines are the extended description (Markdown supported)." class="form-textarea mt-1"></textarea>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Log Level</label>
                            <select x-model="job.loglevel" class="form-select mt-1">
                                <option>DEBUG</option>
                                <option>VERBOSE</option>
                                <option>INFO</option>
                                <option>WARN</option>
                                <option>ERROR</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Workflow Sequence -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Workflow Sequence</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="font-medium text-gray-700">On Step Failure</label>
                             <select x-model="job.sequence.keepgoing" class="form-select mt-1">
                                <option :value="false">Stop at failed step</option>
                                <option :value="true">Run remaining steps</option>
                            </select>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Strategy</label>
                            <select x-model="job.sequence.strategy" class="form-select mt-1">
                                <option>node-first</option>
                                <option>step-first</option>
                                <option>parallel</option>
                            </select>
                        </div>
                    </div>

                    <!-- Steps -->
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Steps</h3>
                    <div x-show="job.sequence.commands.length === 0" class="text-center text-gray-500 py-4 border-2 border-dashed rounded-md">
                        No steps defined. Add one below.
                    </div>

                    <div x-show="job.sequence.commands.length > 0" class="space-y-4">
                        <template x-for="(step, index) in job.sequence.commands" :key="index">
                            <div class="p-4 border rounded-lg bg-gray-50">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-semibold text-gray-800" x-text="`Step ${index + 1}: ${step.type}`"></h4>
                                    <button @click="removeStep(index)" class="btn btn-danger btn-sm">Remove</button>
                                </div>

                                <div class="space-y-3">
                                    <div>
                                        <label class="font-medium text-gray-600 text-sm">Description</label>
                                        <input type="text" x-model="step.description" placeholder="Optional step description" class="form-input text-sm mt-1">
                                    </div>
                                    <!-- Exec -->
                                    <div x-show="step.type === 'exec'">
                                        <label class="font-medium text-gray-600 text-sm">Command</label>
                                        <input type="text" x-model="step.details.exec" placeholder="echo 'hello world'" class="form-input text-sm font-mono mt-1">
                                    </div>
                                    <!-- Script -->
                                    <div x-show="step.type === 'script'">
                                        <label class="font-medium text-gray-600 text-sm">Script Content</label>
                                        <textarea x-model="step.details.script" rows="5" class="form-textarea text-sm font-mono mt-1" placeholder="#!/bin/bash&#10;echo &quot;Hello @option.name@&quot;"></textarea>
                                        <label class="font-medium text-gray-600 text-sm mt-2">Arguments</label>
                                        <input type="text" x-model="step.details.args" placeholder="Optional script arguments" class="form-input text-sm font-mono mt-1">
                                    </div>
                                    <!-- Job Reference -->
                                    <div x-show="step.type === 'jobref'" class="space-y-2">
                                        <label class="font-medium text-gray-600 text-sm">Job Name</label>
                                        <input type="text" x-model="step.details.name" placeholder="Referenced job name" class="form-input text-sm mt-1">
                                        <label class="font-medium text-gray-600 text-sm">Group</label>
                                        <input type="text" x-model="step.details.group" placeholder="Referenced job group (optional)" class="form-input text-sm mt-1">
                                        <label class="font-medium text-gray-600 text-sm">Arguments</label>
                                        <input type="text" x-model="step.details.args" placeholder="-opt1 value1 -opt2 value2" class="form-input text-sm font-mono mt-1">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-4 pt-4 border-t">
                        <label class="font-medium text-gray-700">Add a new step:</label>
                        <div class="flex items-center space-x-2 mt-2">
                            <select x-ref="newStepType" class="form-select">
                                <option value="exec">Command (exec)</option>
                                <option value="script">Inline Script</option>
                                <option value="jobref">Job Reference</option>
                                <option value="scriptfile">Script File</option>
                                <option value="scripturl">Script URL</option>
                            </select>
                            <button @click="addStep($refs.newStepType.value)" class="btn btn-primary">Add Step</button>
                        </div>
                    </div>
                </div>

                <!-- Options -->
                <div class="form-section">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Options</h2>
                    <div x-show="job.options.length === 0" class="text-center text-gray-500 py-4 border-2 border-dashed rounded-md">
                        No options defined. Add one below.
                    </div>
                    <div x-show="job.options.length > 0" class="space-y-4">
                        <template x-for="(option, index) in job.options" :key="index">
                            <div class="p-4 border rounded-lg bg-gray-50">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-gray-800" x-text="`Option: ${option.name || 'new-option'}`"></h4>
                                    <button @click="removeOption(index)" class="btn btn-danger btn-sm">Remove</button>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="font-medium text-gray-600 text-sm">Name</label>
                                        <input type="text" x-model="option.name" class="form-input text-sm mt-1">
                                    </div>
                                    <div>
                                        <label class="font-medium text-gray-600 text-sm">Default Value</label>
                                        <input type="text" x-model="option.value" class="form-input text-sm mt-1">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label class="font-medium text-gray-600 text-sm">Description</label>
                                        <input type="text" x-model="option.description" class="form-input text-sm mt-1">
                                    </div>
                                     <div class="flex items-center space-x-2 pt-2">
                                        <input type="checkbox" :id="'required-'+index" x-model="option.required" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                        <label :for="'required-'+index" class="text-gray-700">Required</label>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <button @click="addOption()" class="btn btn-primary">Add Option</button>
                    </div>
                </div>

            </div>

            <!-- Right Side: YAML Output -->
            <div class="relative">
                <div class="sticky top-8">
                    <div class="form-section">
                        <div class="flex justify-between items-center border-b pb-2 mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Generated YAML</h2>
                            <button @click="copyToClipboard()" x-text="copyButtonText" class="btn btn-secondary">Copy</button>
                        </div>
                        <pre class="bg-gray-800 text-white p-4 rounded-md overflow-x-auto text-sm"
                             x-text="yamlOutput"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function jobBuilder() {
            return {
                job: {
                    name: 'example-job',
                    group: '',
                    description: 'An example job generated by the UI.',
                    loglevel: 'INFO',
                    sequence: {
                        keepgoing: false,
                        strategy: 'node-first',
                        commands: []
                    },
                    options: [],
                },
                copyButtonText: 'Copy',

                init() {
                    // This watcher recalculates the YAML output whenever the job object changes.
                    // A simple getter is used instead for cleaner code. See yamlOutput().
                },

                // STEPS
                addStep(type) {
                    let newStep = { type: type, details: {}, description: '' };
                    if (type === 'exec') newStep.details = { exec: '' };
                    if (type === 'script') newStep.details = { script: '', args: '' };
                    if (type === 'jobref') newStep.details = { name: '', group: '', args: '' };
                    if (type === 'scriptfile') newStep.details = { scriptfile: '', args: '' };
                    if (type === 'scripturl') newStep.details = { scripturl: '', args: '' };
                    this.job.sequence.commands.push(newStep);
                },
                removeStep(index) {
                    this.job.sequence.commands.splice(index, 1);
                },

                // OPTIONS
                addOption() {
                    this.job.options.push({
                        name: `option${this.job.options.length + 1}`,
                        value: '',
                        description: '',
                        required: false
                    });
                },
                removeOption(index) {
                    this.job.options.splice(index, 1);
                },

                // OUTPUT
                get yamlOutput() {
                    // Create a deep copy to safely manipulate for output
                    const rawJob = JSON.parse(JSON.stringify(this.job));

                    // Cleanup function to remove empty/null/default values
                    const cleanup = (obj) => {
                        if (Array.isArray(obj)) {
                            return obj.map(v => cleanup(v)).filter(v => v !== null && v !== undefined);
                        } else if (typeof obj === 'object' && obj !== null) {
                            return Object.entries(obj).reduce((acc, [key, value]) => {
                                if (value === '' || value === null || (Array.isArray(value) && value.length === 0)) {
                                    // Skip empty strings, nulls, and empty arrays
                                } else if (key === 'keepgoing' && value === false) {
                                    // skip default
                                } else if (key === 'strategy' && value === 'node-first') {
                                    // skip default
                                } else if (key === 'loglevel' && value === 'INFO') {
                                    // skip default
                                } else if (key === 'required' && value === false) {
                                    // skip default
                                } else {
                                    const cleanedValue = cleanup(value);
                                    if (cleanedValue !== null && cleanedValue !== '' && (!Array.isArray(cleanedValue) || cleanedValue.length > 0)) {
                                        acc[key] = cleanedValue;
                                    }
                                }
                                return acc;
                            }, {});
                        }
                        return obj;
                    };

                    const jobToRender = {};
                    if (rawJob.name) jobToRender.name = rawJob.name;
                    if (rawJob.group) jobToRender.group = rawJob.group;
                    if (rawJob.description) jobToRender.description = rawJob.description;
                    if (rawJob.loglevel && rawJob.loglevel !== 'INFO') jobToRender.loglevel = rawJob.loglevel;

                    // Process sequence
                    if (rawJob.sequence && rawJob.sequence.commands.length > 0) {
                        jobToRender.sequence = {
                            commands: rawJob.sequence.commands.map(step => {
                                const newStep = {};
                                if(step.description) newStep.description = step.description;

                                if (step.type === 'exec') {
                                    newStep.exec = step.details.exec;
                                } else if (step.type === 'script') {
                                    newStep.script = step.details.script;
                                    if(step.details.args) newStep.args = step.details.args;
                                } else if (step.type === 'jobref') {
                                    newStep.jobref = cleanup(step.details);
                                } else {
                                     newStep[step.type] = cleanup(step.details);
                                }
                                return newStep;
                            }).filter(s => s.exec || s.script || s.jobref || s.scriptfile || s.scripturl)
                        };
                         if (rawJob.sequence.keepgoing) jobToRender.sequence.keepgoing = true;
                         if (rawJob.sequence.strategy !== 'node-first') jobToRender.sequence.strategy = rawJob.sequence.strategy;
                    }

                    // Process options
                    if (rawJob.options && rawJob.options.length > 0) {
                        jobToRender.options = rawJob.options.map(opt => cleanup(opt));
                    }


                    // Final object for YAML conversion is an array with one job
                    const finalObject = [jobToRender];

                    try {
                        return jsyaml.dump(finalObject, { indent: 2, lineWidth: -1, noRefs: true });
                    } catch (e) {
                        return `Error generating YAML:\n${e.message}`;
                    }
                },

                copyToClipboard() {
                    navigator.clipboard.writeText(this.yamlOutput).then(() => {
                        this.copyButtonText = 'Copied!';
                        setTimeout(() => { this.copyButtonText = 'Copy'; }, 2000);
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        this.copyButtonText = 'Error';
                        setTimeout(() => { this.copyButtonText = 'Copy'; }, 2000);
                    });
                }
            };
        }
    </script>
</body>
</html>