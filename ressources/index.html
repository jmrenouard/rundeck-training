<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Ressources Rundeck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        [x-cloak] { display: none !important; }
        .form-input {
            @apply w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:shadow-outline;
        }
        .btn {
            @apply px-4 py-2 font-bold text-white rounded-lg;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-700;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-700;
        }
        .card {
            @apply bg-white shadow-md rounded-lg p-6 mb-6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-8" x-data="rundeckResourceGenerator()" x-cloak>
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-700">Générateur de Fichier de Ressources Rundeck</h1>
        <p class="text-lg text-gray-500 mt-2">Créez et configurez vos nœuds Rundeck facilement.</p>
    </header>

    <!-- Section d'Importation -->
    <div class="card">
        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Importer depuis YAML</h2>
        <p class="text-gray-600 mb-4">Collez un fichier de ressources YAML existant pour commencer.</p>
        <textarea x-model="yamlInput" class="form-input h-32" placeholder="Collez votre YAML ici..."></textarea>
        <div class="mt-4 flex justify-end">
            <button @click="importYaml" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                Importer
            </button>
        </div>
    </div>

    <!-- Section des Nœuds -->
    <div>
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Nœuds</h2>
            <button @click="addNode" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Ajouter un Nœud
            </button>
        </div>

        <template x-for="node in nodes" :key="node.id">
            <div class="card relative">
                <button @click="removeNode(node.id)" class="absolute top-4 right-4 text-gray-400 hover:text-red-500" title="Supprimer ce nœud">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Champs Requis -->
                    <div class="md:col-span-3 font-bold text-lg border-b pb-2 mb-2">Attributs Requis</div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Nodename</label>
                        <input type="text" x-model="node.nodename" class="form-input" placeholder="node-01.example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Hostname</label>
                        <input type="text" x-model="node.hostname" class="form-input" placeholder="192.168.1.10">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Username</label>
                        <input type="text" x-model="node.username" class="form-input" placeholder="rundeck">
                    </div>

                    <!-- Champs Optionnels -->
                    <div class="md:col-span-3 font-bold text-lg border-b pb-2 mb-2 mt-4">Attributs Optionnels</div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-600">Description</label>
                        <input type="text" x-model="node.description" class="form-input" placeholder="Serveur web de production">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-600">Tags (séparés par virgule)</label>
                        <input type="text" x-model="node.tags" class="form-input" placeholder="web,prod,ubuntu">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">OS Family</label>
                        <input type="text" x-model="node.osFamily" class="form-input" placeholder="unix">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">OS Name</label>
                        <input type="text" x-model="node.osName" class="form-input" placeholder="Linux">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">OS Architecture</label>
                        <input type="text" x-model="node.osArch" class="form-input" placeholder="x86_64">
                    </div>
                     <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-600">SSH Key Storage Path</label>
                        <input type="text" x-model="node['ssh-key-storage-path']" class="form-input" placeholder="keys/prod/my-key.pem">
                    </div>

                    <!-- Attributs Personnalisés -->
                    <div class="md:col-span-3">
                        <h3 class="font-bold text-lg border-b pb-2 mb-2 mt-4">Attributs Personnalisés</h3>
                        <template x-for="attr in node.customAttributes" :key="attr.id">
                            <div class="grid grid-cols-11 gap-2 mb-2 items-center">
                                <div class="col-span-5">
                                    <input type="text" x-model="attr.key" class="form-input" placeholder="Clé (ex: app-port)">
                                </div>
                                <div class="col-span-5">
                                    <input type="text" x-model="attr.value" class="form-input" placeholder="Valeur (ex: 8080)">
                                </div>
                                <div class="col-span-1 text-center">
                                    <button @click="removeCustomAttribute(node.id, attr.id)" class="text-gray-400 hover:text-red-500" title="Supprimer cet attribut">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <button @click="addCustomAttribute(node.id)" class="btn btn-secondary mt-2">Ajouter un Attribut</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Section de Sortie -->
    <div class="card mt-8">
        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Résultat YAML</h2>
        <div class="relative">
            <pre class="bg-gray-800 text-white p-4 rounded-lg overflow-x-auto"><code x-text="yamlOutput"></code></pre>
            <button @click="copyToClipboard" class="btn btn-primary absolute top-2 right-2">
                <span x-text="copyButtonText"></span>
            </button>
        </div>
    </div>

</div>

<script>
    function rundeckResourceGenerator() {
        return {
            nodes: [],
            yamlInput: '',
            copyButtonText: 'Copier',
            standardAttributes: ['nodename', 'hostname', 'username', 'description', 'tags', 'osFamily', 'osArch', 'osName', 'osVersion', 'ssh-key-storage-path'],

            init() {
                this.$watch('nodes', () => this.generateYaml(), { deep: true });
                this.addNode(); // Start with one empty node
            },

            get yamlOutput() {
                if (typeof jsyaml === 'undefined') {
                    return "Chargement de la librairie js-yaml...";
                }
                try {
                    const resourceObject = this.nodes.reduce((acc, node) => {
                        if (node.nodename) {
                            const nodeData = {};
                            this.standardAttributes.forEach(attr => {
                                if (node[attr]) {
                                    nodeData[attr] = node[attr];
                                }
                            });
                            node.customAttributes.forEach(attr => {
                                if (attr.key && attr.value) {
                                    nodeData[attr.key] = attr.value;
                                }
                            });
                            // Ensure required fields are present even if empty
                            if (!nodeData.nodename) nodeData.nodename = '';
                            if (!nodeData.hostname) nodeData.hostname = '';
                            if (!nodeData.username) nodeData.username = '';

                            acc[node.nodename] = nodeData;
                        }
                        return acc;
                    }, {});

                    if (Object.keys(resourceObject).length === 0) {
                        return "# Ajoutez un nœud et renseignez son 'nodename' pour commencer.";
                    }

                    return jsyaml.dump(resourceObject, { indent: 2, lineWidth: -1 });
                } catch (e) {
                    console.error(e);
                    return `Erreur de génération YAML: ${e.message}`;
                }
            },

            addNode() {
                this.nodes.push({
                    id: Date.now() + Math.random(),
                    nodename: '',
                    hostname: '',
                    username: '',
                    description: '',
                    tags: '',
                    osFamily: '',
                    osArch: '',
                    osName: '',
                    osVersion: '',
                    'ssh-key-storage-path': '',
                    customAttributes: []
                });
            },

            removeNode(nodeId) {
                this.nodes = this.nodes.filter(n => n.id !== nodeId);
            },

            addCustomAttribute(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (node) {
                    node.customAttributes.push({ id: Date.now() + Math.random(), key: '', value: '' });
                }
            },

            removeCustomAttribute(nodeId, attrId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (node) {
                    node.customAttributes = node.customAttributes.filter(a => a.id !== attrId);
                }
            },

            importYaml() {
                if (typeof jsyaml === 'undefined') {
                    alert("La librairie de parsing YAML n'est pas encore chargée. Veuillez réessayer dans un instant.");
                    return;
                }
                if (!this.yamlInput.trim()) {
                    alert("La zone d'importation est vide.");
                    return;
                }
                try {
                    const data = jsyaml.load(this.yamlInput);
                    if (typeof data !== 'object' || data === null) {
                        throw new Error("Le YAML doit être un objet (une carte de nœuds).");
                    }

                    const newNodes = Object.entries(data).map(([nodename, attributes]) => {
                        const node = {
                            id: Date.now() + Math.random(),
                            customAttributes: []
                        };

                        for (const [key, value] of Object.entries(attributes)) {
                            if (this.standardAttributes.includes(key)) {
                                node[key] = value;
                            } else {
                                node.customAttributes.push({
                                    id: Date.now() + Math.random(),
                                    key: key,
                                    value: value
                                });
                            }
                        }
                        // Ensure nodename from the key is respected if not in attributes
                        if (!node.nodename) {
                            node.nodename = nodename;
                        }

                        return node;
                    });
                    this.nodes = newNodes;
                    this.yamlInput = '';
                } catch (e) {
                    console.error(e);
                    alert(`Erreur lors de l'importation du YAML: ${e.message}`);
                }
            },

            copyToClipboard() {
                navigator.clipboard.writeText(this.yamlOutput).then(() => {
                    this.copyButtonText = 'Copié !';
                    setTimeout(() => {
                        this.copyButtonText = 'Copier';
                    }, 2000);
                }).catch(err => {
                    console.error('Erreur de copie: ', err);
                    alert("La copie a échoué. Veuillez utiliser la copie manuelle.");
                });
            }
        }
    }
</script>
<style>
/* Style additionnel pour s'assurer que le rendu est correct */
pre code {
    white-space: pre-wrap; /* Assure le retour à la ligne du YAML */
}
</style>
</body>
</html>