<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Fichier ACLPolicy pour Rundeck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" integrity="sha384-+Qw1Qn6e6QF6UVx/F4WRzEwA4kQn6Qw1Qn6e6QF6UVx/F4WRzEwA4kQn6Qw1Qn6e" crossorigin="anonymous" defer></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        [x-cloak] { display: none !important; }
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            transition: all 150ms ease-in-out;
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #38bdf8;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.5);
        }
    </style>
</head>
<body
    x-data="aclPolicyGenerator"
    x-init="init()"
    class="bg-slate-100 text-slate-800 font-sans antialiased"
    x-cloak
>
    <div class="flex min-h-screen">
        <!-- Contenu principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 lg:mr-[40rem]">
            <div class="max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-slate-900">Générateur d'ACLPolicy Rundeck</h1>
                    <button @click="addPolicy()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        Ajouter une politique
                    </button>
                </div>

                <!-- Section d'importation -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 mb-8 p-6">
                    <h2 class="text-xl font-bold text-slate-800 mb-3">Importer une politique existante</h2>
                    <textarea x-model="yamlToImport" class="form-input w-full h-32 font-mono text-sm" placeholder="Collez votre contenu .aclpolicy ici..."></textarea>
                    <div class="flex items-center justify-between mt-3">
                        <button @click="importFromYaml()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                            Importer et Remplir le Formulaire
                        </button>
                        <div x-show="importStatus.message"
                             :class="{ 'text-green-600': !importStatus.isError, 'text-red-600': importStatus.isError }"
                             x-text="importStatus.message"
                             class="text-sm font-medium">
                        </div>
                    </div>
                </div>

                <!-- Boucle sur chaque politique -->
                <template x-for="(policy, policyIndex) in policies" :key="policy.id">
                    <div class="bg-white rounded-lg shadow-md border border-slate-200 mb-8">
                        <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-800" x-text="`Politique #${policyIndex + 1}`"></h2>
                            <button @click="removePolicy(policyIndex)" class="text-red-500 hover:text-red-700 transition" x-show="policies.length > 1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Description -->
                            <div>
                                <label :for="`policy-${policyIndex}-description`" class="block text-lg font-semibold mb-2">Description</label>
                                <input :id="`policy-${policyIndex}-description`" type="text" class="form-input" x-model="policy.description" placeholder="Description courte et descriptive...">
                            </div>

                            <!-- Contexte -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3 border-t pt-4">Contexte</h3>
                                <div class="flex items-center space-x-4">
                                    <select x-model="policy.context.type" class="form-input w-1/3">
                                        <option value="project">Projet</option>
                                        <option value="application">Application</option>
                                    </select>
                                    <input type="text" class="form-input w-2/3" x-model="policy.context.value" :placeholder="policy.context.type === 'project' ? 'Nom du projet (ex: MonProjet, ou regex: .*)' : 'rundeck'">
                                </div>
                            </div>

                            <!-- Section 'For' -->
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-semibold">Pour (for)</h3>
                                    <button @click="addResourceRule(policyIndex)" class="px-3 py-1 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 transition">Ajouter une ressource</button>
                                </div>
                                <div class="space-y-4">
                                    <template x-for="(resourceRule, resourceIndex) in policy.for" :key="resourceRule.id">
                                        <div class="bg-slate-50 p-4 rounded-md border border-slate-200">
                                            <div class="flex justify-between items-center mb-3">
                                                 <select x-model="resourceRule.type" class="form-input w-1/3">
                                                    <template x-for="type in Object.keys(aclSchema[policy.context.type] || {})" :key="type">
                                                        <option :value="type" x-text="type"></option>
                                                    </template>
                                                </select>
                                                <button @click="removeResourceRule(policyIndex, resourceIndex)" class="text-red-500 hover:text-red-700 text-sm">Supprimer Ressource</button>
                                            </div>

                                            <!-- Règles de matching -->
                                            <div class="space-y-3 pl-4 border-l-2 border-slate-300">
                                                <template x-for="(rule, ruleIndex) in resourceRule.rules" :key="rule.id">
                                                    <div class="bg-white p-3 rounded border">
                                                        <div class="grid grid-cols-2 gap-4">
                                                            <div>
                                                                <label class="font-medium text-sm">Règle de correspondance</label>
                                                                <div class="flex space-x-2 mt-1">
                                                                    <select x-model="rule.matcher" class="form-input text-sm">
                                                                        <option value="">(aucune)</option>
                                                                        <template x-for="matcher in ruleMatchers" :key="matcher">
                                                                            <option :value="matcher" x-text="matcher"></option>
                                                                        </template>
                                                                    </select>
                                                                    <input type="text" x-model="rule.property" class="form-input text-sm" placeholder="propriété (ex: name)" :list="`datalist-properties-${policyIndex}-${resourceIndex}`">
                                                                </div>
                                                                <input type="text" x-model="rule.value" class="form-input text-sm mt-2" :placeholder="rule.property === 'kind' ? 'valeur (ex: job)' : 'valeur (ex: job-1)'">
                                                                <datalist :id="`datalist-properties-${policyIndex}-${resourceIndex}`">
                                                                    <template x-for="prop in availableProperties(policyIndex, resourceIndex)" :key="prop">
                                                                        <option :value="prop"></option>
                                                                    </template>
                                                                </datalist>
                                                            </div>
                                                            <div>
                                                                <fieldset>
                                                                    <legend class="font-medium text-sm">Actions</legend>
                                                                    <div class="mt-1">
                                                                        <label 
                                                                            :for="`actions-allow-${policyIndex}-${resourceIndex}-${ruleIndex}`" 
                                                                            class="text-sm block"
                                                                        >Actions autorisées</label>
                                                                        <input 
                                                                            type="text" 
                                                                            x-model="rule.actions.allow" 
                                                                            class="form-input text-sm" 
                                                                            placeholder="Autoriser (allow), séparé par virgule"
                                                                            :id="`actions-allow-${policyIndex}-${resourceIndex}-${ruleIndex}`"
                                                                            :list="`datalist-actions-${policyIndex}-${resourceIndex}`"
                                                                        >
                                                                        <label 
                                                                            :for="`actions-deny-${policyIndex}-${resourceIndex}-${ruleIndex}`" 
                                                                            class="text-sm block mt-2"
                                                                        >Actions refusées</label>
                                                                        <input 
                                                                            type="text" 
                                                                            x-model="rule.actions.deny" 
                                                                            class="form-input text-sm mt-1" 
                                                                            placeholder="Refuser (deny), séparé par virgule"
                                                                            :id="`actions-deny-${policyIndex}-${resourceIndex}-${ruleIndex}`"
                                                                            :list="`datalist-actions-${policyIndex}-${resourceIndex}`"
                                                                        >
                                                                    </div>
                                                                    <datalist :id="`datalist-actions-${policyIndex}-${resourceIndex}`">
                                                                        <template x-for="action in availableActions(policyIndex, resourceIndex)" :key="action">
                                                                            <option :value="action"></option>
                                                                        </template>
                                                                    </datalist>
                                                                </fieldset>
                                                            </div>
                                                        </div>
                                                         <div class="text-right mt-2">
                                                            <button @click="removeRule(policyIndex, resourceIndex, ruleIndex)" class="text-xs text-red-500 hover:text-red-700">Retirer la règle</button>
                                                        </div>
                                                    </div>
                                                </template>
                                                 <button @click="addRule(policyIndex, resourceIndex)" class="px-2 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600 transition">+ Règle</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Sections By / NotBy -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
                                <!-- By -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2">Par (by)</h3>
                                    <div class="space-y-2">
                                        <input type="text" class="form-input" x-model="policy.by.username" placeholder="Utilisateurs (username), séparé par virgule">
                                        <input type="text" class="form-input" x-model="policy.by.group" placeholder="Groupes (group), séparé par virgule">
                                        <input type="text" class="form-input" x-model="policy.by.urn" placeholder="URNs, séparé par virgule">
                                    </div>
                                </div>
                                <!-- NotBy -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-2">Pas par (notBy)</h3>
                                    <div class="space-y-2">
                                        <input type="text" class="form-input" x-model="policy.notBy.username" placeholder="Utilisateurs (username), séparé par virgule">
                                        <input type="text" class="form-input" x-model="policy.notBy.group" placeholder="Groupes (group), séparé par virgule">
                                        <input type="text" class="form-input" x-model="policy.notBy.urn" placeholder="URNs, séparé par virgule">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </main>

        <!-- Panneau de résultat YAML -->
        <aside class="fixed top-0 right-0 h-screen w-[40rem] hidden lg:flex flex-col p-4">
            <div class="bg-slate-800 rounded-lg shadow-2xl overflow-hidden h-full flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center p-4 bg-slate-900">
                    <h3 class="text-lg font-semibold text-white">Fichier .aclpolicy généré</h3>
                    <button @click="copyToClipboard()" class="flex items-center gap-2 px-4 py-2 bg-sky-600 text-white rounded-md text-sm hover:bg-sky-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <span x-text="copySuccess ? 'Copié !' : 'Copier'"></span>
                    </button>
                </div>
                <pre class="flex-1 overflow-y-auto p-4"><code class="text-slate-300 text-sm whitespace-pre-wrap" x-text="generatedYamlContent"></code></pre>
            </div>
        </aside>
    </div>

    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('aclPolicyGenerator', () => ({
            policies: [
                {
                    id: Date.now(),
                    description: '',
                    context: { type: 'project', value: '.*' },
                    for: [],
                    by: { username: '', group: '', urn: '' },
                    notBy: { username: '', group: '', urn: '' },
                }
            ],
            copySuccess: false,
            yamlToImport: '',
            importStatus: { message: '', isError: false },
            ruleMatchers: ['equals', 'match', 'contains', 'subset'],

            //-= ACL Schema based on Rundeck Documentation =-
            aclSchema: {
                application: {
                    resource: {
                        actions: [
                            // project
                            'create',
                            // system
                            'read', 'view_cluster', 'enable_executions', 'disable_executions', 'admin',
                            // system_acl
                            'create', 'update', 'delete',
                            // user
                            'admin',
                            // job
                            'admin',
                            // apitoken
                            'generate_user_token', 'generate_service_token', 'admin',
                            // plugin
                            'read', 'install', 'uninstall', 'admin',
                            // runner
                            'read', 'create', 'update', 'delete', 'ping', 'regenerate_credentials'
                        ],
                        properties: ['kind'],
                        kinds: ['project', 'system', 'system_acl', 'user', 'job', 'apitoken', 'plugin', 'runner']
                    },
                    project: {
                        actions: ['read', 'configure', 'delete', 'import', 'export', 'scm_import', 'scm_export', 'delete_execution', 'admin'],
                        properties: ['name']
                    },
                    project_acl: {
                        actions: ['read', 'create', 'update', 'delete', 'admin'],
                        properties: ['name']
                    },
                    storage: {
                        actions: ['create', 'update', 'read', 'delete'],
                        properties: ['path', 'name']
                    },
                    apitoken: {
                        actions: ['create'],
                        properties: ['username', 'roles']
                    }
                },
                project: {
                    resource: {
                        actions: [
                            // job
                            'create', 'delete', 'scm_create', 'scm_delete',
                            // node
                            'read', 'create', 'update', 'refresh',
                            // event
                            'read', 'create',
                            // webhook
                            'admin', 'read', 'create', 'update', 'delete', 'post',
                            // runner
                            'read', 'create', 'update', 'delete', 'ping', 'regenerate_credentials'
                        ],
                        properties: ['kind'],
                        kinds: ['job', 'node', 'event', 'webhook', 'runner']
                    },
                    adhoc: {
                        actions: ['read', 'run', 'runAs', 'kill', 'killAs'],
                        properties: [] // No specific properties to match on
                    },
                    job: {
                        actions: ['read', 'view', 'update', 'delete', 'run', 'runAs', 'kill', 'killAs', 'create', 'toggle_schedule', 'toggle_execution', 'scm_create', 'scm_update', 'scm_delete', 'view_history'],
                        properties: ['name', 'group', 'uuid']
                    },
                    node: {
                        actions: ['read', 'run'],
                        properties: ['rundeck_server', 'nodename', 'username', 'hostname', 'description', 'tags', 'osName', 'osFamily', 'osVersion', 'osArch']
                    },
                    runner: {
                        actions: ['read', 'create', 'update', 'delete', 'ping', 'admin'],
                        properties: ['name', 'id', 'tags']
                    }
                }
            },

            init() {
                // The first policy is now added declaratively.
            },

            availableActions(policyIndex, resourceIndex) {
                const policy = this.policies[policyIndex];
                const resourceRule = policy?.for?.[resourceIndex];
                if (!policy || !resourceRule) return [];

                const contextType = policy.context.type;
                const resourceType = resourceRule.type;

                return this.aclSchema[contextType]?.[resourceType]?.actions || [];
            },

            availableProperties(policyIndex, resourceIndex) {
                const policy = this.policies[policyIndex];
                const resourceRule = policy?.for?.[resourceIndex];
                if (!policy || !resourceRule) return [];

                const contextType = policy.context.type;
                const resourceType = resourceRule.type;

                let properties = this.aclSchema[contextType]?.[resourceType]?.properties || [];

                // If the resource is of type 'resource' and has 'kinds', add the properties of the kinds
                if (resourceType === 'resource') {
                    const kinds = this.aclSchema[contextType]?.[resourceType]?.kinds || [];
                    const kindProperties = kinds.flatMap(kind => this.aclSchema[contextType]?.[kind]?.properties || []);
                    properties = [...new Set([...properties, ...kindProperties])];
                }

                return properties;
            },

            importFromYaml() {
                if (!this.yamlToImport.trim()) {
                    this.showImportStatus('Le champ est vide.', true);
                    return;
                }
                try {
                    const docs = jsyaml.loadAll(this.yamlToImport);
                    const importedPolicies = docs.map(doc => {
                        if (typeof doc !== 'object' || doc === null) return null;

                        const newPolicy = this.newPolicy();

                        // Description & Context
                        newPolicy.description = doc.description || '';
                        if (doc.context?.project) {
                            newPolicy.context = { type: 'project', value: doc.context.project };
                        } else if (doc.context?.application) {
                            newPolicy.context = { type: 'application', value: doc.context.application };
                        }

                        // 'by' and 'notBy' sections
                        ['by', 'notBy'].forEach(key => {
                            if (!doc[key]) return;
                            Object.keys(doc[key]).forEach(prop => {
                                const value = doc[key][prop];
                                newPolicy[key][prop] = Array.isArray(value) ? value.join(', ') : value;
                            });
                        });

                        // 'for' section
                        if (doc.for) {
                            newPolicy.for = Object.entries(doc.for).map(([type, rules]) => {
                                const resourceRule = this.newResourceRule();
                                resourceRule.type = type;
                                resourceRule.rules = rules.map(rule => {
                                    const newRule = this.newRule();
                                    const matcher = Object.keys(rule).find(k => this.ruleMatchers.includes(k));

                                    if (matcher) {
                                        newRule.matcher = matcher;
                                        const matchContent = rule[matcher];
                                        newRule.property = Object.keys(matchContent)[0] || '';
                                        newRule.value = Object.values(matchContent)[0] || '';
                                    }

                                    newRule.actions.allow = this._normalizeActions(rule.allow);
                                    newRule.actions.deny = this._normalizeActions(rule.deny);
                                    return newRule;
                                });
                                return resourceRule;
                            });
                        }

                        return newPolicy;
                    }).filter(Boolean);

                    if (importedPolicies.length > 0) {
                        this.policies = importedPolicies;
                        this.showImportStatus(`Importation réussie : ${importedPolicies.length} politique(s) chargée(s).`);
                    } else {
                        this.showImportStatus('Aucune politique valide trouvée dans le YAML.', true);
                    }

                } catch (e) {
                    this.showImportStatus(`Erreur de parsing YAML : ${e.message}`, true);
                    console.error(e);
                }
            },

            showImportStatus(message, isError = false) {
                this.importStatus = { message, isError };
                setTimeout(() => { this.importStatus.message = ''; }, 5000);
            },

            newPolicy() {
                return {
                    id: Date.now() + Math.random(),
                    description: '',
                    context: { type: 'project', value: '.*' },
                    for: [],
                    by: { username: '', group: '', urn: '' },
                    notBy: { username: '', group: '', urn: '' },
                }
            },

            newResourceRule() {
                return { id: Date.now() + Math.random(), type: 'resource', rules: [this.newRule()] }
            },

            newRule() {
                return {
                    id: Date.now() + Math.random(),
                    matcher: '',
                    property: '',
                    value: '',
                    actions: { allow: '', deny: '' }
                }
            },

            addPolicy() {
                this.policies.push(this.newPolicy());
            },

            removePolicy(index) {
                this.policies.splice(index, 1);
            },

            addResourceRule(policyIndex) {
                this.policies[policyIndex].for.push(this.newResourceRule());
            },

            removeResourceRule(policyIndex, resourceIndex) {
                this.policies[policyIndex].for.splice(resourceIndex, 1);
            },

            addRule(policyIndex, resourceIndex) {
                this.policies[policyIndex].for[resourceIndex].rules.push(this.newRule());
            },

            removeRule(policyIndex, resourceIndex, ruleIndex) {
                this.policies[policyIndex].for[resourceIndex].rules.splice(ruleIndex, 1);
            },

            copyToClipboard() {
                if (this.generatedYamlContent) {
                    navigator.clipboard.writeText(this.generatedYamlContent);
                    this.copySuccess = true;
                    setTimeout(() => { this.copySuccess = false; }, 2000);
                }
            },

            // Helper pour normaliser les actions en chaîne de caractères
            _normalizeActions(actions) {
                if (!actions) return '';
                if (Array.isArray(actions)) return actions.join(', ');
                return String(actions);
            },

            // Helper pour transformer les chaines de caractères en tableaux
            _splitAndTrim(str) {
                if (!str || typeof str !== 'string') return [];
                const arr = str.split(',').map(item => item.trim()).filter(Boolean);
                return arr;
            },

            get generatedYamlContent() {
                if (typeof jsyaml === 'undefined') {
                    return 'Génération du YAML...';
                }
                try {
                    const yamlDocs = this.policies.map(policy => {
                        const out = {};

                        if (policy.description) {
                            out.description = policy.description;
                        }

                        out.context = {};
                        if (policy.context.type && policy.context.value) {
                            out.context[policy.context.type] = policy.context.value;
                        }

                        // Construction de la section 'for'
                        const forSection = {};
                        policy.for.forEach(resourceRule => {
                            if (!forSection[resourceRule.type]) {
                                forSection[resourceRule.type] = [];
                            }
                            resourceRule.rules.forEach(rule => {
                                const ruleOutput = {};
                                if (rule.matcher && rule.property && rule.value) {
                                    ruleOutput[rule.matcher] = { [rule.property]: rule.value };
                                }

                                const allowActions = this._splitAndTrim(rule.actions.allow);
                                if (allowActions.length > 0) ruleOutput.allow = allowActions;

                                const denyActions = this._splitAndTrim(rule.actions.deny);
                                if (denyActions.length > 0) ruleOutput.deny = denyActions;

                                if (Object.keys(ruleOutput).length > 0) {
                                    forSection[resourceRule.type].push(ruleOutput);
                                }
                            });
                        });
                        if (Object.keys(forSection).length > 0) {
                            out.for = forSection;
                        }

                        // Construction des sections 'by' et 'notBy'
                        ['by', 'notBy'].forEach(key => {
                            const bySection = {};
                            ['username', 'group', 'urn'].forEach(prop => {
                                const values = this._splitAndTrim(policy[key][prop]);
                                if (values.length > 0) bySection[prop] = values;
                            });
                             if (Object.keys(bySection).length > 0) {
                                out[key] = bySection;
                            }
                        });

                        return jsyaml.dump(out, { indent: 2, lineWidth: -1, noRefs: true });
                    });

                    return yamlDocs.join('---\n');
                } catch (e) {
                    console.error(e);
                    return `Erreur lors de la génération du YAML:\n${e.message}`;
                }
            }
        }));
    });
    </script>
</body>
</html>